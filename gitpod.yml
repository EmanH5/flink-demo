tasks:
  - name: Setup JDK, Maven, Flink & Confluent CLI
    init: |
      sudo apt-get update
      sudo apt-get install -y openjdk-17-jdk maven curl gnupg
      # Install Confluent CLI (Debian/Ubuntu method)
      sudo mkdir -p /etc/apt/keyrings
      curl -s https://packages.confluent.io/confluent-cli/deb/archive.key | sudo gpg --dearmor -o /etc/apt/keyrings/confluent-cli.gpg
      echo "deb [signed-by=/etc/apt/keyrings/confluent-cli.gpg] https://packages.confluent.io/confluent-cli/deb stable main" | sudo tee /etc/apt/sources.list.d/confluent-cli.list >/dev/null
      sudo apt-get update && sudo apt-get install -y confluent-cli
      # Download Flink 2.1.0
      curl -LO https://downloads.apache.org/flink/flink-2.1.0/flink-2.1.0-bin-scala_2.12.tgz
      tar -xzf flink-2.1.0-bin-scala_2.12.tgz
      rm flink-2.1.0-bin-scala_2.12.tgz
      # Ensure Flink UI binds to 0.0.0.0 for Gitpod
      sed -i 's@^#\?rest.bind-address:.*@rest.bind-address: 0.0.0.0@g' flink-2.1.0/conf/flink-conf.yaml || true
    command: |
      # start Flink local cluster
      ./flink-2.1.0/bin/start-cluster.sh
      echo "Flink UI at port 8081"
ports:
  - port: 8081
    onOpen: open-browser
    visibility: public
